<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>View Dependencies &mdash; FastAPI-JSONAPI 2.8.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=69ff2ef9"></script>
        <script src="_static/doctools.js?v=9a2dae69"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Filtering" href="filtering.html" />
    <link rel="prev" title="Atomic Operations" href="atomic_operations.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            FastAPI-JSONAPI
          </a>
              <div class="version">
                2.8
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="minimal_api_example.html">A minimal API</a></li>
<li class="toctree-l1"><a class="reference internal" href="api_filtering_example.html">Filtering API example</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="api_limited_methods_example.html">Limit API methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="routing.html">Routing</a></li>
<li class="toctree-l1"><a class="reference internal" href="atomic_operations.html">Atomic Operations</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">View Dependencies</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#handlers">Handlers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="filtering.html">Filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="updated_includes_example.html">Create and include related objects (updated example)</a></li>
<li class="toctree-l1"><a class="reference internal" href="include_related_objects.html">Include related objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="include_many_to_many.html">Include nested and related, Many-to-Many</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom_sql_filtering.html">Custom SQL filtering</a></li>
<li class="toctree-l1"><a class="reference internal" href="client_generated_id.html">Client generated id</a></li>
<li class="toctree-l1"><a class="reference internal" href="logical_data_abstraction.html">Logical data abstraction</a></li>
<li class="toctree-l1"><a class="reference internal" href="data_layer.html">Data layer</a></li>
<li class="toctree-l1"><a class="reference internal" href="relationships.html">Define relationships</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="sparse_fieldsets.html">Sparse fieldsets</a></li>
<li class="toctree-l1"><a class="reference internal" href="pagination.html">Pagination</a></li>
<li class="toctree-l1"><a class="reference internal" href="sorting.html">Sorting</a></li>
<li class="toctree-l1"><a class="reference internal" href="errors.html">Errors</a></li>
<li class="toctree-l1"><a class="reference internal" href="permission.html">Permission</a></li>
<li class="toctree-l1"><a class="reference internal" href="oauth.html">OAuth</a></li>
<li class="toctree-l1"><a class="reference internal" href="fastapi-jsonapi.html">Package fastapi_jsonapi index</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">FastAPI-JSONAPI</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">View Dependencies</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/view_dependencies.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="view-dependencies">
<span id="id1"></span><h1>View Dependencies<a class="headerlink" href="#view-dependencies" title="Link to this heading">ÔÉÅ</a></h1>
<p>As you already know, in the process of its work, FastAPI-JSONAPI interacts between application layers.
Sometimes there are things that are necessary to process requests but are only computable at runtime.
In order for ResourceManager and DataLayer to use such things, there is a mechanism called <strong>method_dependencies</strong>.</p>
<p>The most common cases of such things are database session and access handling.
The example below demonstrates some simple implementation of these ideas using sqlalchemy.</p>
<p>Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">ClassVar</span><span class="p">,</span> <span class="n">Dict</span>

<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">Depends</span><span class="p">,</span> <span class="n">Header</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.engine</span> <span class="kn">import</span> <span class="n">make_url</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.asyncio</span> <span class="kn">import</span> <span class="n">AsyncSession</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.asyncio</span> <span class="kn">import</span> <span class="n">create_async_engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">sessionmaker</span>
<span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Annotated</span>

<span class="kn">from</span> <span class="nn">fastapi_jsonapi.exceptions</span> <span class="kn">import</span> <span class="n">Forbidden</span>
<span class="kn">from</span> <span class="nn">fastapi_jsonapi.misc.sqla.generics.base</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DetailViewBaseGeneric</span><span class="p">,</span>
    <span class="n">ListViewBaseGeneric</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">fastapi_jsonapi.views.utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">HTTPMethod</span><span class="p">,</span>
    <span class="n">HTTPMethodConfig</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">fastapi_jsonapi.views.view_base</span> <span class="kn">import</span> <span class="n">ViewBase</span>


<span class="k">def</span> <span class="nf">get_async_sessionmaker</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">sessionmaker</span><span class="p">:</span>
    <span class="n">_async_session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span>
        <span class="n">bind</span><span class="o">=</span><span class="n">create_async_engine</span><span class="p">(</span>
            <span class="n">url</span><span class="o">=</span><span class="n">make_url</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;sqlite+aiosqlite:///tmp/db.sqlite3&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">),</span>
        <span class="n">class_</span><span class="o">=</span><span class="n">AsyncSession</span><span class="p">,</span>
        <span class="n">expire_on_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">_async_session</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">async_session_dependency</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get session as dependency</span>

<span class="sd">    :return:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">session_maker</span> <span class="o">=</span> <span class="n">get_async_sessionmaker</span><span class="p">()</span>
    <span class="k">async</span> <span class="k">with</span> <span class="n">session_maker</span><span class="p">()</span> <span class="k">as</span> <span class="n">db_session</span><span class="p">:</span>  <span class="c1"># type: AsyncSession</span>
        <span class="k">yield</span> <span class="n">db_session</span>
        <span class="k">await</span> <span class="n">db_session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">SessionDependency</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">async_session_dependency</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Config</span><span class="p">:</span>
        <span class="n">arbitrary_types_allowed</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">common_handler</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="n">ViewBase</span><span class="p">,</span> <span class="n">dto</span><span class="p">:</span> <span class="n">SessionDependency</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;session&quot;</span><span class="p">:</span> <span class="n">dto</span><span class="o">.</span><span class="n">session</span><span class="p">}</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">check_that_user_is_admin</span><span class="p">(</span><span class="n">x_auth</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Header</span><span class="p">()]):</span>
    <span class="k">if</span> <span class="n">x_auth</span> <span class="o">!=</span> <span class="s2">&quot;admin&quot;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Forbidden</span><span class="p">(</span><span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Only admin user have permissions to this endpoint&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">AdminOnlyPermission</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">is_admin</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">check_that_user_is_admin</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DetailView</span><span class="p">(</span><span class="n">DetailViewBaseGeneric</span><span class="p">):</span>
    <span class="n">method_dependencies</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">HTTPMethod</span><span class="p">,</span> <span class="n">HTTPMethodConfig</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">HTTPMethod</span><span class="o">.</span><span class="n">ALL</span><span class="p">:</span> <span class="n">HTTPMethodConfig</span><span class="p">(</span>
            <span class="n">dependencies</span><span class="o">=</span><span class="n">SessionDependency</span><span class="p">,</span>
            <span class="n">prepare_data_layer_kwargs</span><span class="o">=</span><span class="n">common_handler</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">}</span>


<span class="k">class</span> <span class="nc">ListView</span><span class="p">(</span><span class="n">ListViewBaseGeneric</span><span class="p">):</span>
    <span class="n">method_dependencies</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="n">HTTPMethod</span><span class="p">,</span> <span class="n">HTTPMethodConfig</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">HTTPMethod</span><span class="o">.</span><span class="n">GET</span><span class="p">:</span> <span class="n">HTTPMethodConfig</span><span class="p">(</span><span class="n">dependencies</span><span class="o">=</span><span class="n">AdminOnlyPermission</span><span class="p">),</span>
        <span class="n">HTTPMethod</span><span class="o">.</span><span class="n">ALL</span><span class="p">:</span> <span class="n">HTTPMethodConfig</span><span class="p">(</span>
            <span class="n">dependencies</span><span class="o">=</span><span class="n">SessionDependency</span><span class="p">,</span>
            <span class="n">prepare_data_layer_kwargs</span><span class="o">=</span><span class="n">common_handler</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>In this example, the focus should be on the <strong>HTTPMethod</strong> and <strong>HTTPMethodConfig</strong> entities.
By setting the <strong>method_dependencies</strong> attribute, you can set FastAPI dependencies for endpoints,
as well as manage the creation of additional kwargs needed to initialize the DataLayer.</p>
<p>Dependencies can be any Pydantic model containing Depends as default values.
It‚Äôs really the same as if you defined the dependency session for the endpoint as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">Depends</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.asyncio</span> <span class="kn">import</span> <span class="n">AsyncSession</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/items&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_items</span><span class="p">(</span><span class="n">session</span><span class="p">:</span> <span class="n">AsyncSession</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">async_session_dependency</span><span class="p">)):</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>Dependencies do not have to be used to generate DataLayer keys and can be used for any purpose,
as is the case with the <strong>check_that_user_is_admin</strong> function, which is used to check permissions.
In case the header ‚ÄúX-AUTH‚Äù is not equal to ‚Äúadmin‚Äù, the Forbidden response will be returned.</p>
<p>In this case, if you do not set the ‚ÄúX-AUTH‚Äù header, it will work like this</p>
<p>Request:</p>
<div class="highlight-HTTP notranslate"><div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/users</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/vnd.api+json</span>
</pre></div>
</div>
<p>Response:</p>
<div class="highlight-HTTP notranslate"><div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">403</span> <span class="ne">Forbidden</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/vnd.api+json</span>

<span class="p">{</span>
<span class="w">   </span><span class="nt">&quot;errors&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">         </span><span class="nt">&quot;detail&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Only admin user have permissions to this endpoint&quot;</span><span class="p">,</span>
<span class="w">         </span><span class="nt">&quot;status_code&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">403</span><span class="p">,</span>
<span class="w">         </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Forbidden&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">   </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>and when ‚ÄúX-AUTH‚Äù is set, it will work like this</p>
<p>Request:</p>
<div class="highlight-HTTP notranslate"><div class="highlight"><pre><span></span><span class="nf">GET</span> <span class="nn">/users</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/vnd.api+json</span>
<span class="na">X-AUTH</span><span class="o">:</span> <span class="l">admin</span>
</pre></div>
</div>
<p>Response:</p>
<div class="highlight-HTTP notranslate"><div class="highlight"><pre><span></span><span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span> <span class="m">200</span> <span class="ne">OK</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/vnd.api+json</span>

<span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;attributes&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;name&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;John&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;links&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;self&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/users/1&quot;</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">],</span>
<span class="w">  </span><span class="nt">&quot;jsonapi&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;version&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1.0&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;links&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;self&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;http://localhost:5000/users&quot;</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nt">&quot;meta&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="handlers">
<h2>Handlers<a class="headerlink" href="#handlers" title="Link to this heading">ÔÉÅ</a></h2>
<p>As noted above, dependencies can be used to create a kwargs for a DataLayer.
To do this, you need to define <strong>prepare_data_layer_kwargs</strong> in <strong>HTTPMethodConfig</strong>.
This is a callable object which can be synchronous or asynchronous.</p>
<p>Its signature should look like this</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">my_handler</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="n">ViewBase</span><span class="p">,</span> <span class="n">dto</span><span class="p">:</span> <span class="n">BaseModel</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>or this</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">my_handler</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="n">ViewBase</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>In the case of dto, it is an instance of the class corresponds to what
is in <strong>HTTPMethodConfig.dependencies</strong> and should only be present in the function
signature if dependencies is not None.</p>
<p>The <strong>HTTPMethodConfig.ALL</strong> method has special behavior. When declared,
its dependencies will be passed to each endpoint regardless of the existence of other configs.</p>
<p>Explaining with a specific example, in the case when <strong>HTTPMethod.ALL</strong> is declared and
it has dependencies, and also a method such as <strong>HTTPMethod.GET</strong> also has dependencies,
the signature for the <strong>HTTPMethod.GET</strong> handler will be a union of dependencies</p>
<p>Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">ClassVar</span>

<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">Depends</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>

<span class="kn">from</span> <span class="nn">fastapi_jsonapi.misc.sqla.generics.base</span> <span class="kn">import</span> <span class="n">DetailViewBaseGeneric</span>
<span class="kn">from</span> <span class="nn">fastapi_jsonapi.views.utils</span> <span class="kn">import</span> <span class="n">HTTPMethod</span><span class="p">,</span> <span class="n">HTTPMethodConfig</span>
<span class="kn">from</span> <span class="nn">fastapi_jsonapi.views.view_base</span> <span class="kn">import</span> <span class="n">ViewBase</span>


<span class="k">def</span> <span class="nf">one</span><span class="p">():</span>
    <span class="k">return</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">two</span><span class="p">():</span>
    <span class="k">return</span> <span class="mi">2</span>


<span class="k">class</span> <span class="nc">CommonDependency</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">key_1</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">one</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">GetDependency</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">key_2</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">two</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DependencyMix</span><span class="p">(</span><span class="n">CommonDependency</span><span class="p">,</span> <span class="n">GetDependency</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">common_handler</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="n">ViewBase</span><span class="p">,</span> <span class="n">dto</span><span class="p">:</span> <span class="n">CommonDependency</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;key_1&quot;</span><span class="p">:</span> <span class="n">dto</span><span class="o">.</span><span class="n">key_1</span><span class="p">}</span>


<span class="k">def</span> <span class="nf">get_handler</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="n">ViewBase</span><span class="p">,</span> <span class="n">dto</span><span class="p">:</span> <span class="n">DependencyMix</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;key_2&quot;</span><span class="p">:</span> <span class="n">dto</span><span class="o">.</span><span class="n">key_2</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">DetailView</span><span class="p">(</span><span class="n">DetailViewBaseGeneric</span><span class="p">):</span>
    <span class="n">method_dependencies</span><span class="p">:</span> <span class="n">ClassVar</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">HTTPMethod</span><span class="o">.</span><span class="n">ALL</span><span class="p">:</span> <span class="n">HTTPMethodConfig</span><span class="p">(</span>
            <span class="n">dependencies</span><span class="o">=</span><span class="n">CommonDependency</span><span class="p">,</span>
            <span class="n">prepare_data_layer_kwargs</span><span class="o">=</span><span class="n">common_handler</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="n">HTTPMethod</span><span class="o">.</span><span class="n">GET</span><span class="p">:</span> <span class="n">HTTPMethodConfig</span><span class="p">(</span>
            <span class="n">dependencies</span><span class="o">=</span><span class="n">GetDependency</span><span class="p">,</span>
            <span class="n">prepare_data_layer_kwargs</span><span class="o">=</span><span class="n">get_handler</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">}</span>
</pre></div>
</div>
<p>In this case DataLayer.__init__ will get <code class="docutils literal notranslate"><span class="pre">{&quot;key_1&quot;:</span> <span class="pre">1,</span> <span class="pre">&quot;key_2&quot;:</span> <span class="pre">2}</span></code> as kwargs.</p>
<p>You can take advantage of this knowledge and do something with the <code class="docutils literal notranslate"><span class="pre">key_1</span></code> value,
because before entering the DataLayer, the results of both handlers are defined as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dl_kwargs</span> <span class="o">=</span> <span class="n">common_handler</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">dto</span><span class="p">)</span>
<span class="n">dl_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">get_handler</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">dto</span><span class="p">))</span>
</pre></div>
</div>
<p>You can override the value of <code class="docutils literal notranslate"><span class="pre">key_1</span></code> in the handler</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_handler</span><span class="p">(</span><span class="n">view</span><span class="p">:</span> <span class="n">ViewBase</span><span class="p">,</span> <span class="n">dto</span><span class="p">:</span> <span class="n">DependencyMix</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;key_1&quot;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span> <span class="s2">&quot;key_2&quot;</span><span class="p">:</span> <span class="n">dto</span><span class="o">.</span><span class="n">key_2</span><span class="p">}</span>
</pre></div>
</div>
<p>or just overriding the dependency</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">view</span><span class="p">,</span> <span class="n">dto</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">42</span>

<span class="k">class</span> <span class="nc">GetDependency</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">key_1</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
    <span class="n">key_2</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">Depends</span><span class="p">(</span><span class="n">two</span><span class="p">)</span>
</pre></div>
</div>
<p>In both cases DataLayer.__init__ will get <code class="docutils literal notranslate"><span class="pre">{&quot;key_1&quot;:</span> <span class="pre">42,</span> <span class="pre">&quot;key_2&quot;:</span> <span class="pre">2}</span></code> as kwargs</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="atomic_operations.html" class="btn btn-neutral float-left" title="Atomic Operations" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="filtering.html" class="btn btn-neutral float-right" title="Filtering" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, MTS AI.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>